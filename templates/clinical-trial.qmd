---
title: "Clinical Trial Template"
subtitle: "Bayesian adaptive trial design and calibration"
---

## Overview

Template for Bayesian adaptive clinical trial design, featuring multi-fidelity simulation, Bayesian optimization for calibration, and regulatory documentation.

**Repository**: [github.com/rashidlab/template-clinical-trial](https://github.com/rashidlab/template-clinical-trial)

## Features

- Multi-fidelity BO calibration via BATON
- Operating characteristics simulation
- Statistical Analysis Plan generation
- Protocol documentation templates
- Regulatory-ready outputs
- Slurm integration for large-scale runs

## Quick Start

```bash
# Clone
git clone git@github.com:rashidlab/template-clinical-trial.git my-trial

# Set up
cd my-trial
rm -rf .git && git init

# Install dependencies
# In R:
# Install packages listed in DESCRIPTION

# Also need BATON
devtools::install("~/Downloads/BATON")

# Quick test
QUICK_MODE=1 targets::tar_make()
```

## Directory Structure

```
my-trial/
├── _targets.R              # Calibration pipeline
├── R/
│   ├── simulator.R         # Trial simulator
│   ├── calibration.R       # BO calibration
│   ├── diagnostics.R       # Convergence checks
│   └── globals_loader.R
├── config/
│   ├── globals.yml         # Trial parameters & bounds
│   └── consistency_registry.yml
├── scenarios/              # Design scenarios
│   └── trial_scenarios.csv
├── manuscript/             # Methods paper
├── protocol/               # Protocol documents
│   ├── sap.qmd             # Statistical Analysis Plan
│   └── design_report.qmd
├── results/
│   ├── calibration/        # BO results
│   └── operating_chars/    # OC tables
├── figures/
├── scripts/
│   └── run_calibration.R
├── DESCRIPTION
└── Makefile
```

## Configuration

Edit `config/globals.yml`:

```yaml
project:
  name: "My Adaptive Trial"
  seed: 2024

trial:
  # Sample size bounds
  n_min: 20
  n_max: 100
  n_interim: 5

  # Operating characteristic targets
  target_power: 0.80
  target_type1: 0.05

calibration:
  # Bayesian optimization settings
  budget_stage1: 40
  budget_stage2: 20
  n_init: 20

  # Fidelity levels
  fidelity_low: 500
  fidelity_med: 2000
  fidelity_high: 10000

  # Parameter bounds
  bounds:
    p_efficacy: [0.85, 0.99]
    p_futility: [0.01, 0.30]

slurm:
  partition: "general"
  cpus_per_task: 4
  memory_gb: 8
```

## Calibration Pipeline

```r
# _targets.R
library(targets)
library(BATON)

source("R/globals_loader.R")
cfg <- load_globals()

list(
  # Load scenarios
  tar_target(scenarios, load_scenarios("scenarios/trial_scenarios.csv")),

  # Calibration with multi-fidelity BO
  tar_target(
    calibration_results,
    run_calibration(
      scenarios,
      simulator = simulate_trial,
      bounds = cfg$calibration$bounds,
      fidelity_levels = c(
        low = cfg$calibration$fidelity_low,
        med = cfg$calibration$fidelity_med,
        high = cfg$calibration$fidelity_high
      ),
      target_power = cfg$trial$target_power,
      target_type1 = cfg$trial$target_type1,
      budget = cfg$calibration$budget_stage1 + cfg$calibration$budget_stage2
    ),
    pattern = map(scenarios)
  ),

  # Extract best designs
  tar_target(
    best_designs,
    extract_best_designs(calibration_results)
  ),

  # Operating characteristics at final design
  tar_target(
    oc_table,
    compute_operating_characteristics(
      best_designs,
      n_reps = cfg$calibration$fidelity_high
    )
  ),

  # Outputs
  tar_target(fig_oc, create_oc_figure(oc_table)),
  tar_quarto(sap, path = "protocol/sap.qmd")
)
```

## Running Calibration

```bash
# Full calibration (on Longleaf)
sbatch scripts/run_calibration.sh

# Quick test locally
QUICK_MODE=1 Rscript -e "targets::tar_make(calibration_results)"

# Monitor progress
Rscript -e "targets::tar_progress()"
```

## Diagnostic Reports

After calibration:

```r
# Check convergence
targets::tar_read(calibration_results) |>
  check_convergence()

# Generate diagnostic plots
create_calibration_diagnostics(
  targets::tar_read(calibration_results),
  output_dir = "figures/diagnostics/"
)
```

## Protocol Documents

Generate regulatory documents:

```bash
# Statistical Analysis Plan
make sap

# Design report with OC tables
make design-report
```

## Common Commands

```bash
make calibrate        # Run BO calibration
make calibrate-quick  # Quick test mode
make oc               # Operating characteristics
make sap              # Generate SAP
make validate         # Check consistency
```

## Integration with BATON

Key functions from the BATON package:

```r
library(BATON)

# Main calibration
results <- bo_calibrate(
  sim_fun = my_simulator,
  bounds = list(p_E = c(0.85, 0.99), p_F = c(0.01, 0.30)),
  objective = "EN",
  constraints = list(power = 0.80, type1 = 0.05),
  fidelity_levels = c(low = 500, med = 2000, high = 10000)
)

# Extract optimal design
best <- extract_best(results)
```
